const { GoogleGenerativeAI } = require("@google/generative-ai");
const fs = require('fs');
const path = require('path');

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

async function run() {
  const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
  const csvData = fs.readFileSync('news.csv', 'utf8');

  const today = new Date().toISOString().split('T')[0]; // UTC基準の当日日付

  const prompt = `
    当日の日付は${today}（UTC基準）です。
    news.csvを読んで文字の羅列から記事の見出しを抽出して羅列する。英語は日本語に翻訳する。
    手順1、文字の羅列から「媒体・分野ごとの区切り」、「記事の見出し」と「年月日に関わる情報」のみを抽出する。これをAとする。
    手順2、Aのにある記事見出し情報を「記事の見出し」＋「媒体・分野」＋「年月日」の形で1行ごとにまとめる。
       例　「見出し」(ロイター)2025/06/01
    手順3、「〇日前」という曖昧な時系列情報は現在の日付から年月日を推測する。
    手順4、当日より3日以上前の記事見出しは削除する。
    手順5、「〇時間前」の記事は当日の記事として扱う。
    手順6、「記事の見出し」＋「媒体・分野」＋「年月日」の形にまとめられない不明瞭な情報は削除する。
    手順7、下記に示した●●で囲まれた媒体、分野ごとに記事を並べる。勝手な省略や削除は厳禁。
    手順8、●●で囲まれた一つの媒体・分野ごとに、記事数は新しいものから順に最大25件とする。25件を超える分は削除する。
    手順9、全ての媒体・分野セクション（●●ヤフー●●、●●AI●●を含む）を必ず出力すること。途中で出力を打ち切らないこと。
    ﻿●●ロイタービジネス●●　日本時間（UTC+9）
    ●●ロイター経済●●　日本時間（UTC+9）
    ●●ロイターオピニオン●●　日本時間（UTC+9）
    ●●ロイター市場●●　日本時間（UTC+9）
    ●●ブルームバーグ●●　日本時間（UTC+9）
    ●●BBC●●　UTC
    ●●国内etc●●　日本時間（UTC+9）
    ●●NYタイムズ●●　UTC
    ●●WSJ●●　日本時間（UTC+9）
    ●●ヤフー●●　日本時間（UTC+9）
    ●●AI●●　日本時間（UTC+9）

当日の日付は${today}（UTC基準）です。
以下のデータから記事の見出しを抽出・整理してください。英語の見出しはすべて自然な日本語に翻訳してください。
■手順
1. 文字の羅列から「媒体・分野ごとの区切り（●●〇〇●●）」「記事の見出し」「年月日に関わる情報」のみを抽出する。これをAとする。
   以下はノイズなので無視する：ナビゲーション要素、フッター・ヘッダー、広告、著作権表示、記事本文・要約文、市場データ表、記者名、UI要素（「category」「検索」「ログイン」「SKIP TO CONTENT」「opens new tab」「Report Ad」「advertisement」「もっと見る」等）、動画・音声・ポッドキャスト、料理レシピ、ゲーム、製品レビュー等。
2. Aにある記事見出しを「記事の見出し」＋「媒体・分野」＋「年月日」の形で1行ごとにまとめる。
   例：「エヌビディアやソフト大手の決算、AI相場の次の試金石に」(ロイタービジネス)2026/02/22
3. 「〇日前」という曖昧な時系列情報は現在の日付から年月日を推測する。
   「1日前」「昨日」→当日の前日、「2日前」→当日の2日前、のように逆算する。
4. 当日より3日以上前の記事見出しは削除する（当日・1日前・2日前のみ残す）。
5. 「〇時間前」「〇分前」の記事は当日の記事として扱う。
6. 「記事の見出し」＋「媒体・分野」＋「年月日」の形にまとめられない不明瞭な情報は削除する。

7. 下記に示した●●で囲まれた媒体・分野ごとに記事を並べる。同一媒体内の重複は1つにまとめる。
8. ●●で囲まれた一つの媒体・分野ごとに、記事数は新しいものから順に最大40件とする。40件を超える分は削除する。
9. 全ての媒体・分野セクション（●●ヤフー●●、●●AI●●を含む）を必ず出力すること。途中で出力を打ち切らないこと。
●●ロイタービジネス●●　日本時間（UTC+9）
●●ロイター経済●●　日本時間（UTC+9）
●●ロイターオピニオン●●　日本時間（UTC+9）
●●ロイター市場●●　日本時間（UTC+9）
●●ブルームバーグ●●　日本時間（UTC+9）
●●BBC●●　UTC
●●国内etc●●　日本時間（UTC+9）
●●NYタイムズ●●　UTC
●●WSJ●●　日本時間（UTC+9）
●●ヤフー●●　日本時間（UTC+9）
●●AI●●　日本時間（UTC+9）

■補足
- 国内etcセクションはCSV形式（カンマ区切り）で「日経1」「時事1」「yahoo1」等のラベルの後に続く文字列が見出し。
- ヤフーセクション（●●ヤフー●●）はYahoo!ニュースのトピックス一覧。「国内」「国際」「経済」「エンタメ」「スポーツ」「IT」「科学」「地域」等のカテゴリ別に短い見出しが並ぶ。各トピック名が見出し。年月日は当日を用いる。媒体が不明の場合は「yahoo」とする。「もっと見る」「トピックス一覧」等のナビ要素は無視する。「あなたにおすすめ」以降の記事も含め、記事見出しと判断できるものは全て抽出すること。
- AI関連セクション（●●AI●●）はGoogleニュースのAI関連記事。「〇時間前」「〇日前」「昨日」等の時間情報から日付を推測する。「もっと見る」「検索オプション」等のナビ要素は無視する。
- 各媒体内は日付の新しい順に並べる。
 
    リスト：
    ${csvData}
  `;

  const result = await model.generateContent(prompt);
  const summaryText = result.response.text();
  fs.writeFileSync('summary1.txt', summaryText);
}

run();
